var GMKB=function(m){"use strict";class g{constructor(t={}){this.state={components:{},sections:[],theme:"default",globalSettings:{},...t},this.listeners=new Set}getState(){return this.state}dispatch(t){switch(console.log("üîÑ Action:",t.type,t.payload),t.type){case"SET_STATE":this.state={...this.state,...t.payload};break;case"ADD_COMPONENT":const n=t.payload;this.state.components[n.id]=n,this.addComponentToSection(n.id,n.sectionId);break;case"REMOVE_COMPONENT":const e=t.payload,s=this.state.components[e];s&&(this.removeComponentFromSection(e,s.sectionId),delete this.state.components[e]);break;case"UPDATE_COMPONENT":const{id:i,updates:c}=t.payload;this.state.components[i]&&(this.state.components[i]={...this.state.components[i],...c});break;case"ADD_SECTION":this.state.sections.push(t.payload);break;case"UPDATE_SECTIONS":this.state.sections=t.payload;break;case"SET_THEME":this.state.theme=t.payload;break;default:console.warn("Unknown action type:",t.type)}this.notify()}addComponentToSection(t,n){const e=this.state.sections.find(s=>s.section_id===n);e&&!e.components.includes(t)&&e.components.push(t)}removeComponentFromSection(t,n){const e=this.state.sections.find(s=>s.section_id===n);e&&(e.components=e.components.filter(s=>s!==t))}subscribe(t){return this.listeners.add(t),()=>this.listeners.delete(t)}notify(){this.listeners.forEach(t=>t(this.state))}}class v{constructor(){this.events=new Map}on(t,n){return this.events.has(t)||this.events.set(t,new Set),this.events.get(t).add(n),()=>this.off(t,n)}off(t,n){this.events.has(t)&&this.events.get(t).delete(n)}emit(t,n){console.log("üì¢ Event:",t,n),this.events.has(t)&&this.events.get(t).forEach(e=>{try{e(n)}catch(s){console.error(`Error in ${t} handler:`,s)}})}once(t,n){const e=s=>{n(s),this.off(t,e)};return this.on(t,e)}}const u={},E={};function w(o,t,n=null){return u[o]=t,n&&(E[o]=n),console.log(`‚úÖ Registered component: ${o}`),!0}function b(o){return o in u}function C(o){if(!b(o))return console.warn(`Component type "${o}" not found in registry`),k(o);const t=u[o];return typeof t=="object"&&t.render?t.render:t}function O(o){return E[o]||null}function k(o){return function(n){const e=n.data||n.props||{};let s="";switch(o){case"hero":s=`
          <div class="gmkb-hero">
            <h1>${e.title||e.full_name||"Guest Name"}</h1>
            ${e.subtitle?`<h2>${e.subtitle}</h2>`:""}
            ${e.description?`<p>${e.description}</p>`:""}
          </div>
        `;break;case"biography":s=`
          <div class="gmkb-biography">
            <h2>Biography</h2>
            <p>${e.biography||"No biography available."}</p>
          </div>
        `;break;case"topics":const c=e.topics||[];s=`
          <div class="gmkb-topics">
            <h2>Topics</h2>
            ${c.length>0?`<ul>${c.map(l=>`<li>${l}</li>`).join("")}</ul>`:"<p>No topics available.</p>"}
          </div>
        `;break;case"contact":s=`
          <div class="gmkb-contact">
            <h2>Contact</h2>
            ${e.email?`<p>Email: ${e.email}</p>`:""}
            ${e.phone?`<p>Phone: ${e.phone}</p>`:""}
            ${e.website?`<p>Website: ${e.website}</p>`:""}
          </div>
        `;break;case"cta":case"call-to-action":s=`
          <div class="gmkb-cta">
            <h2>${e.title||"Call to Action"}</h2>
            ${e.description?`<p>${e.description}</p>`:""}
            ${e.button_text?`<button class="btn btn-primary">${e.button_text}</button>`:""}
          </div>
        `;break;case"testimonials":const r=e.testimonials||[];s=`
          <div class="gmkb-testimonials">
            <h2>Testimonials</h2>
            ${r.length>0?r.map(l=>`
                <blockquote>
                  <p>${l.text||""}</p>
                  <cite>- ${l.author||"Anonymous"}</cite>
                </blockquote>
              `).join(""):"<p>No testimonials available.</p>"}
          </div>
        `;break;default:s=`
          <div class="gmkb-component gmkb-component--${o}">
            <h3>${o.charAt(0).toUpperCase()+o.slice(1)} Component</h3>
            <pre>${JSON.stringify(e,null,2)}</pre>
          </div>
        `}const i=document.createElement("div");return i.innerHTML=s,i.firstElementChild}}async function L(){return["hero","biography","topics","contact","cta","testimonials"].forEach(t=>{b(t)||w(t,k(t))}),console.log("‚úÖ Component renderers loaded:",Object.keys(u)),u}typeof window<"u"&&(window.GMKBComponentRegistry={register:w,get:C,has:b,getSchema:O});const d={info:(...o)=>console.log("‚ÑπÔ∏è",...o),warn:(...o)=>console.warn("‚ö†Ô∏è",...o),error:(...o)=>console.error("‚ùå",...o),success:(...o)=>console.log("‚úÖ",...o),debug:(...o)=>{var t;(t=window.gmkbData)!=null&&t.debugMode&&console.log("üêõ",...o)}};class S{constructor(t,n="media-kit-preview"){if(this.stateManager=t,this.container=document.getElementById(n),!this.container){d.error(`Container #${n} not found`);return}this.unsubscribe=this.stateManager.subscribe(()=>this.render()),this.render()}render(){const t=this.stateManager.getState();d.debug("üé® Rendering state:",t),this.container.innerHTML="",this.container.className=`preview-area theme-${t.theme||"default"}`,t.sections&&t.sections.length>0?this.renderSections(t):Object.keys(t.components).length>0?this.renderComponentsDirectly(t):this.renderEmptyState()}renderSections(t){t.sections.forEach(n=>{const e=this.renderSection(n,t);e&&this.container.appendChild(e)})}renderSection(t,n){const e=document.createElement("div");e.className=`gmkb-section gmkb-section--${t.type||"full-width"}`,e.setAttribute("data-section-id",t.section_id);const s=document.createElement("div");return s.className="gmkb-section__content",t.components&&t.components.length>0?t.components.forEach(i=>{const c=n.components[i];if(c){const r=this.renderComponent(c);r&&s.appendChild(r)}}):s.innerHTML=`
        <div class="gmkb-section__empty" data-drop-zone="true">
          <p>Drop components here</p>
        </div>
      `,this.addSectionControls(e,t),e.appendChild(s),e}renderComponentsDirectly(t){Object.values(t.components).forEach(n=>{const e=this.renderComponent(n);e&&this.container.appendChild(e)})}renderComponent(t){const n=C(t.type);if(!n)return d.warn(`No renderer for component type: ${t.type}`),this.renderFallbackComponent(t);try{let e;if(typeof n=="function")e=n(t);else if(n.render)e=n.render(t);else throw new Error("Invalid renderer format");if(typeof e=="string"){const i=document.createElement("div");i.innerHTML=e,e=i.firstElementChild||i}const s=document.createElement("div");return s.className=`gmkb-component gmkb-component--${t.type}`,s.setAttribute("data-component-id",t.id),s.setAttribute("data-component-type",t.type),this.addComponentControls(s,t),s.appendChild(e),s}catch(e){return d.error(`Error rendering component ${t.id}:`,e),this.renderFallbackComponent(t)}}renderFallbackComponent(t){const n=document.createElement("div");return n.className=`gmkb-component gmkb-component--${t.type} gmkb-component--fallback`,n.setAttribute("data-component-id",t.id),n.innerHTML=`
      <div class="component-fallback">
        <h4>${t.type}</h4>
        <p>Component ID: ${t.id}</p>
      </div>
    `,this.addComponentControls(n,t),n}addComponentControls(t,n){const e=document.createElement("div");e.className="component-controls",e.innerHTML=`
      <button class="control-btn move-up" data-action="move-up" title="Move Up">‚Üë</button>
      <button class="control-btn move-down" data-action="move-down" title="Move Down">‚Üì</button>
      <button class="control-btn edit" data-action="edit" title="Edit">‚úèÔ∏è</button>
      <button class="control-btn duplicate" data-action="duplicate" title="Duplicate">üìã</button>
      <button class="control-btn delete" data-action="delete" title="Delete">üóëÔ∏è</button>
    `,e.addEventListener("click",s=>{const i=s.target.dataset.action;i&&this.handleComponentAction(i,n.id)}),t.appendChild(e)}addSectionControls(t,n){const e=document.createElement("div");e.className="section-controls",e.innerHTML=`
      <button class="control-btn delete" data-action="delete-section" title="Delete Section">üóëÔ∏è</button>
      <button class="control-btn settings" data-action="section-settings" title="Section Settings">‚öôÔ∏è</button>
    `,e.addEventListener("click",s=>{const i=s.target.dataset.action;i&&this.handleSectionAction(i,n.section_id)}),t.appendChild(e)}handleComponentAction(t,n){document.dispatchEvent(new CustomEvent("gmkb:component-action",{detail:{action:t,componentId:n}}))}handleSectionAction(t,n){document.dispatchEvent(new CustomEvent("gmkb:section-action",{detail:{action:t,sectionId:n}}))}renderEmptyState(){this.container.innerHTML=`
      <div class="gmkb-empty-state">
        <h3>No components yet</h3>
        <p>Click "Add Component" to get started</p>
        <button id="empty-state-add-btn" class="btn btn-primary">Add Component</button>
      </div>
    `;const t=this.container.querySelector("#empty-state-add-btn");t&&t.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("gmkb:open-component-library"))})}destroy(){this.unsubscribe&&this.unsubscribe()}}class _{constructor(t,n,e){var s,i,c;this.ajaxUrl=t||((s=window.gmkbData)==null?void 0:s.ajaxUrl),this.nonce=n||((i=window.gmkbData)==null?void 0:i.nonce),this.postId=e||((c=window.gmkbData)==null?void 0:c.postId)}async save(t){var e;const n=new FormData;n.append("action","gmkb_save_media_kit"),n.append("nonce",this.nonce),n.append("post_id",this.postId),n.append("state",JSON.stringify(t));try{const s=await fetch(this.ajaxUrl,{method:"POST",body:n});if(!s.ok)throw new Error(`Save failed: ${s.statusText}`);const i=await s.json();if(!i.success)throw new Error(((e=i.data)==null?void 0:e.message)||"Save failed");return i.data}catch(s){throw console.error("Save failed:",s),s}}async load(){var n;const t=new FormData;t.append("action","gmkb_load_media_kit"),t.append("nonce",this.nonce),t.append("post_id",this.postId);try{const e=await fetch(this.ajaxUrl,{method:"POST",body:t});if(!e.ok)throw new Error(`Load failed: ${e.statusText}`);const s=await e.json();if(!s.success)throw new Error(((n=s.data)==null?void 0:n.message)||"Load failed");return s.data}catch(e){return console.error("Load failed:",e),null}}async loadComponent(t){var e;const n=new FormData;n.append("action","gmkb_load_component"),n.append("nonce",this.nonce),n.append("component_id",t),n.append("post_id",this.postId);try{const i=await(await fetch(this.ajaxUrl,{method:"POST",body:n})).json();if(!i.success)throw new Error(((e=i.data)==null?void 0:e.message)||"Load failed");return i.data}catch(s){return console.error("Component load failed:",s),null}}}let a,T,f,$;async function D(){var o,t;d.info("üöÄ Initializing Media Kit Builder v3.0");try{T=new v,f=new _,await L();const n=((o=window.gmkbData)==null?void 0:o.savedState)||((t=window.gmkbData)==null?void 0:t.saved_state)||{};n.components||(n.components={}),(!n.sections||!Array.isArray(n.sections))&&(n.sections=[],Object.keys(n.components).length>0&&(n.sections=[{section_id:`section_${Date.now()}`,type:"full_width",components:Object.keys(n.components)}])),a=new g(n),$=new S(a),A(),B(),P(),window.GMKB={stateManager:a,eventBus:T,apiService:f,renderer:$,version:"3.0.0",addComponent:(e,s={})=>{const i=`${e}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,c={id:i,type:e,data:s,props:s},r=a.getState();if(r.sections.length===0){const l=`section_${Date.now()}`;a.dispatch({type:"ADD_SECTION",payload:{section_id:l,type:"full_width",components:[]}}),c.sectionId=l}else c.sectionId=r.sections[0].section_id;return a.dispatch({type:"ADD_COMPONENT",payload:c}),i},removeComponent:e=>{a.dispatch({type:"REMOVE_COMPONENT",payload:e})},save:()=>y(),getState:()=>a.getState()},d.success("Media Kit Builder initialized successfully"),document.dispatchEvent(new CustomEvent("gmkb:ready",{detail:{version:"3.0.0"}}))}catch(n){d.error("Initialization failed:",n),q("Failed to initialize Media Kit Builder")}}function A(){const o=document.getElementById("save-btn");o&&o.addEventListener("click",async()=>{await y()});const t=document.getElementById("add-component-btn");t&&t.addEventListener("click",()=>{M()});const n=document.getElementById("add-section-btn");n&&n.addEventListener("click",()=>{H()});const e=document.getElementById("theme-select");e&&e.addEventListener("change",i=>{a.dispatch({type:"SET_THEME",payload:i.target.value})}),document.querySelectorAll("[data-device]").forEach(i=>{i.addEventListener("click",()=>{const c=i.dataset.device;K(c)})})}function B(){document.addEventListener("gmkb:component-action",o=>{const{action:t,componentId:n}=o.detail;switch(t){case"delete":confirm("Delete this component?")&&a.dispatch({type:"REMOVE_COMPONENT",payload:n});break;case"duplicate":U(n);break;case"edit":x(n);break;case"move-up":N(n,-1);break;case"move-down":N(n,1);break}}),document.addEventListener("gmkb:section-action",o=>{const{action:t,sectionId:n}=o.detail;switch(t){case"delete-section":confirm("Delete this section and all its components?")&&R(n);break;case"section-settings":F(n);break}}),document.addEventListener("gmkb:open-component-library",M)}function P(){let o;a.subscribe(()=>{clearTimeout(o),o=setTimeout(()=>{y(!0)},5e3)})}async function y(o=!1){const t=document.getElementById("save-btn");!o&&t&&(t.disabled=!0,t.textContent="Saving...");try{const n=a.getState();await f.save(n),o||p("Saved successfully","success"),d.success("State saved")}catch(n){d.error("Save failed:",n),o||p("Save failed","error")}finally{!o&&t&&(t.disabled=!1,t.textContent="Save")}}function M(){const o=document.getElementById("component-library-modal");o?(o.style.display="block",I()):j()}function j(){const o=document.createElement("div");o.id="component-library-modal",o.className="modal",o.innerHTML=`
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add Component</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body" id="component-library-list"></div>
    </div>
  `,document.body.appendChild(o),o.querySelector(".modal-close").addEventListener("click",()=>{o.style.display="none"}),o.addEventListener("click",t=>{t.target===o&&(o.style.display="none")}),I()}function I(){var n;const o=document.getElementById("component-library-list");if(!o)return;const t=((n=window.gmkbData)==null?void 0:n.components)||[{type:"hero",name:"Hero",description:"Hero section with title and image"},{type:"biography",name:"Biography",description:"Professional biography"},{type:"topics",name:"Topics",description:"Speaking topics list"},{type:"contact",name:"Contact",description:"Contact information"},{type:"cta",name:"Call to Action",description:"CTA button section"},{type:"testimonials",name:"Testimonials",description:"Client testimonials"}];o.innerHTML=t.map(e=>`
    <div class="component-card" data-component-type="${e.type}">
      <h3>${e.name}</h3>
      <p>${e.description}</p>
      <button class="btn btn-primary add-component-btn" data-type="${e.type}">
        Add ${e.name}
      </button>
    </div>
  `).join(""),o.querySelectorAll(".add-component-btn").forEach(e=>{e.addEventListener("click",()=>{const s=e.dataset.type;window.GMKB.addComponent(s);const i=document.getElementById("component-library-modal");i&&(i.style.display="none"),p(`Added ${s} component`,"success")})})}function H(o="full_width"){const n={section_id:`section_${Date.now()}`,type:o,components:[]};a.dispatch({type:"ADD_SECTION",payload:n}),p("Section added","success")}function R(o){const t=a.getState(),n=t.sections.filter(s=>s.section_id!==o),e=t.sections.find(s=>s.section_id===o);e&&e.components&&e.components.forEach(s=>{a.dispatch({type:"REMOVE_COMPONENT",payload:s})}),a.dispatch({type:"UPDATE_SECTIONS",payload:n})}function U(o){const n=a.getState().components[o];if(n){const e=`${n.type}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,s={...n,id:e,data:{...n.data}};a.dispatch({type:"ADD_COMPONENT",payload:s}),p("Component duplicated","success")}}function N(o,t){const n=a.getState(),e=n.components[o];if(!e||!e.sectionId)return;const s=n.sections.find(h=>h.section_id===e.sectionId);if(!s)return;const i=s.components.indexOf(o);if(i===-1)return;const c=i+t;if(c<0||c>=s.components.length)return;const r=[...s.components];[r[i],r[c]]=[r[c],r[i]];const l=n.sections.map(h=>h.section_id===s.section_id?{...h,components:r}:h);a.dispatch({type:"UPDATE_SECTIONS",payload:l})}function x(o){const t=a.getState().components[o];t&&(console.log("Edit component:",t),p("Component editor not yet implemented","info"))}function F(o){console.log("Edit section:",o),p("Section settings not yet implemented","info")}function K(o){const t=document.getElementById("media-kit-preview")||document.getElementById("preview-area");t&&(t.className=`preview-area device-${o}`)}function p(o,t="info",n=3e3){const e=document.createElement("div");e.className=`toast toast--${t}`,e.textContent=o,document.body.appendChild(e),setTimeout(()=>{e.classList.add("toast--visible")},10),setTimeout(()=>{e.classList.remove("toast--visible"),setTimeout(()=>e.remove(),300)},n)}function q(o){p(o,"error",5e3)}return document.readyState==="loading"?document.addEventListener("DOMContentLoaded",D):D(),m.APIService=_,m.EventBus=v,m.Renderer=S,m.StateManager=g,m.logger=d,Object.defineProperty(m,Symbol.toStringTag,{value:"Module"}),m}({});
