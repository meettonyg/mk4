var GMKB=function(u){"use strict";class g{constructor(t={}){this.state={components:{},sections:[],theme:"default",globalSettings:{},...t},this.listeners=new Set}getState(){return this.state}dispatch(t){switch(console.log("üîÑ Action:",t.type,t.payload),t.type){case"SET_STATE":this.state={...this.state,...t.payload};break;case"ADD_COMPONENT":const n=t.payload;this.state.components[n.id]=n,this.addComponentToSection(n.id,n.sectionId);break;case"REMOVE_COMPONENT":const e=t.payload,o=this.state.components[e];o&&(this.removeComponentFromSection(e,o.sectionId),delete this.state.components[e]);break;case"UPDATE_COMPONENT":const{id:i,updates:c}=t.payload;this.state.components[i]&&(this.state.components[i]={...this.state.components[i],...c});break;case"ADD_SECTION":this.state.sections.push(t.payload);break;case"UPDATE_SECTIONS":this.state.sections=t.payload;break;case"SET_THEME":this.state.theme=t.payload;break;default:console.warn("Unknown action type:",t.type)}this.notify()}addComponentToSection(t,n){const e=this.state.sections.find(o=>o.section_id===n);e&&!e.components.includes(t)&&e.components.push(t)}removeComponentFromSection(t,n){const e=this.state.sections.find(o=>o.section_id===n);e&&(e.components=e.components.filter(o=>o!==t))}subscribe(t){return this.listeners.add(t),()=>this.listeners.delete(t)}notify(){this.listeners.forEach(t=>t(this.state))}}class v{constructor(){this.events=new Map}on(t,n){return this.events.has(t)||this.events.set(t,new Set),this.events.get(t).add(n),()=>this.off(t,n)}off(t,n){this.events.has(t)&&this.events.get(t).delete(n)}emit(t,n){console.log("üì¢ Event:",t,n),this.events.has(t)&&this.events.get(t).forEach(e=>{try{e(n)}catch(o){console.error(`Error in ${t} handler:`,o)}})}once(t,n){const e=o=>{n(o),this.off(t,e)};return this.on(t,e)}}const h={},E={};function w(s,t,n=null){return h[s]=t,n&&(E[s]=n),console.log(`‚úÖ Registered component: ${s}`),!0}function b(s){return s in h}function C(s){if(!b(s))return console.warn(`Component type "${s}" not found in registry`),k(s);const t=h[s];return typeof t=="object"&&t.render?t.render:t}function A(s){return E[s]||null}function k(s){return function(n){const e=n.data||n.props||{};let o="";switch(s){case"hero":o=`
          <div class="gmkb-hero">
            <h1>${e.title||e.full_name||"Guest Name"}</h1>
            ${e.subtitle?`<h2>${e.subtitle}</h2>`:""}
            ${e.description?`<p>${e.description}</p>`:""}
          </div>
        `;break;case"biography":o=`
          <div class="gmkb-biography">
            <h2>Biography</h2>
            <p>${e.biography||"No biography available."}</p>
          </div>
        `;break;case"topics":const c=e.topics||[];o=`
          <div class="gmkb-topics">
            <h2>Topics</h2>
            ${c.length>0?`<ul>${c.map(l=>`<li>${l}</li>`).join("")}</ul>`:"<p>No topics available.</p>"}
          </div>
        `;break;case"contact":o=`
          <div class="gmkb-contact">
            <h2>Contact</h2>
            ${e.email?`<p>Email: ${e.email}</p>`:""}
            ${e.phone?`<p>Phone: ${e.phone}</p>`:""}
            ${e.website?`<p>Website: ${e.website}</p>`:""}
          </div>
        `;break;case"cta":case"call-to-action":o=`
          <div class="gmkb-cta">
            <h2>${e.title||"Call to Action"}</h2>
            ${e.description?`<p>${e.description}</p>`:""}
            ${e.button_text?`<button class="btn btn-primary">${e.button_text}</button>`:""}
          </div>
        `;break;case"testimonials":const d=e.testimonials||[];o=`
          <div class="gmkb-testimonials">
            <h2>Testimonials</h2>
            ${d.length>0?d.map(l=>`
                <blockquote>
                  <p>${l.text||""}</p>
                  <cite>- ${l.author||"Anonymous"}</cite>
                </blockquote>
              `).join(""):"<p>No testimonials available.</p>"}
          </div>
        `;break;default:o=`
          <div class="gmkb-component gmkb-component--${s}">
            <h3>${s.charAt(0).toUpperCase()+s.slice(1)} Component</h3>
            <pre>${JSON.stringify(e,null,2)}</pre>
          </div>
        `}const i=document.createElement("div");return i.innerHTML=o,i.firstElementChild}}async function B(){return["hero","biography","topics","contact","cta","testimonials"].forEach(t=>{b(t)||w(t,k(t))}),console.log("‚úÖ Component renderers loaded:",Object.keys(h)),h}typeof window<"u"&&(window.GMKBComponentRegistry={register:w,get:C,has:b,getSchema:A});const r={info:(...s)=>console.log("‚ÑπÔ∏è",...s),warn:(...s)=>console.warn("‚ö†Ô∏è",...s),error:(...s)=>console.error("‚ùå",...s),success:(...s)=>console.log("‚úÖ",...s),debug:(...s)=>{var t;(t=window.gmkbData)!=null&&t.debugMode&&console.log("üêõ",...s)}};class S{constructor(t,n="media-kit-preview"){if(this.stateManager=t,this.container=document.getElementById(n),!this.container){r.error(`Container #${n} not found`);return}const e=document.getElementById("empty-state"),o=document.getElementById("saved-components-container");e&&(e.style.display="none"),o&&(o.style.display="block"),this.unsubscribe=this.stateManager.subscribe(()=>this.render()),this.render()}render(){const t=this.stateManager.getState();r.debug("üé® Rendering state:",t);const n=Object.keys(t.components).length>0,e=t.sections&&t.sections.length>0,o=document.getElementById("empty-state"),i=document.getElementById("saved-components-container");if(!n&&!e){o&&(o.style.display="block"),i&&(i.style.display="none"),this.renderEmptyState();return}o&&(o.style.display="none"),i&&(i.style.display="block"),this.container.innerHTML="",(this.container.id==="media-kit-preview"||this.container.id==="gmkb-preview-area")&&(this.container.className=`preview-area theme-${t.theme||"default"}`),e?this.renderSections(t):n&&this.renderComponentsDirectly(t)}renderSections(t){t.sections.forEach(n=>{const e=this.renderSection(n,t);e&&this.container.appendChild(e)})}renderSection(t,n){const e=document.createElement("div");e.className=`gmkb-section gmkb-section--${t.type||"full-width"}`,e.setAttribute("data-section-id",t.section_id);const o=document.createElement("div");return o.className="gmkb-section__content",t.components&&t.components.length>0?t.components.forEach(i=>{const c=n.components[i];if(c){const d=this.renderComponent(c);d&&o.appendChild(d)}}):o.innerHTML=`
        <div class="gmkb-section__empty" data-drop-zone="true">
          <p>Drop components here</p>
        </div>
      `,this.addSectionControls(e,t),e.appendChild(o),e}renderComponentsDirectly(t){Object.values(t.components).forEach(n=>{const e=this.renderComponent(n);e&&this.container.appendChild(e)})}renderComponent(t){const n=C(t.type);if(!n)return r.warn(`No renderer for component type: ${t.type}`),this.renderFallbackComponent(t);try{let e;if(typeof n=="function")e=n(t);else if(n.render)e=n.render(t);else throw new Error("Invalid renderer format");if(typeof e=="string"){const i=document.createElement("div");i.innerHTML=e,e=i.firstElementChild||i}const o=document.createElement("div");return o.className=`gmkb-component gmkb-component--${t.type}`,o.setAttribute("data-component-id",t.id),o.setAttribute("data-component-type",t.type),this.addComponentControls(o,t),o.appendChild(e),o}catch(e){return r.error(`Error rendering component ${t.id}:`,e),this.renderFallbackComponent(t)}}renderFallbackComponent(t){const n=document.createElement("div");return n.className=`gmkb-component gmkb-component--${t.type} gmkb-component--fallback`,n.setAttribute("data-component-id",t.id),n.innerHTML=`
      <div class="component-fallback">
        <h4>${t.type}</h4>
        <p>Component ID: ${t.id}</p>
      </div>
    `,this.addComponentControls(n,t),n}addComponentControls(t,n){const e=document.createElement("div");e.className="component-controls",e.innerHTML=`
      <button class="control-btn move-up" data-action="move-up" title="Move Up">‚Üë</button>
      <button class="control-btn move-down" data-action="move-down" title="Move Down">‚Üì</button>
      <button class="control-btn edit" data-action="edit" title="Edit">‚úèÔ∏è</button>
      <button class="control-btn duplicate" data-action="duplicate" title="Duplicate">üìã</button>
      <button class="control-btn delete" data-action="delete" title="Delete">üóëÔ∏è</button>
    `,e.addEventListener("click",o=>{const i=o.target.dataset.action;i&&this.handleComponentAction(i,n.id)}),t.appendChild(e)}addSectionControls(t,n){const e=document.createElement("div");e.className="section-controls",e.innerHTML=`
      <button class="control-btn delete" data-action="delete-section" title="Delete Section">üóëÔ∏è</button>
      <button class="control-btn settings" data-action="section-settings" title="Section Settings">‚öôÔ∏è</button>
    `,e.addEventListener("click",o=>{const i=o.target.dataset.action;i&&this.handleSectionAction(i,n.section_id)}),t.appendChild(e)}handleComponentAction(t,n){document.dispatchEvent(new CustomEvent("gmkb:component-action",{detail:{action:t,componentId:n}}))}handleSectionAction(t,n){document.dispatchEvent(new CustomEvent("gmkb:section-action",{detail:{action:t,sectionId:n}}))}renderEmptyState(){const t=document.getElementById("empty-state");if(t){const e=t.querySelector("#add-first-component"),o=t.querySelector("#add-first-section");e&&!e.hasAttribute("data-listener-attached")&&(e.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("gmkb:open-component-library"))}),e.setAttribute("data-listener-attached","true")),o&&!o.hasAttribute("data-listener-attached")&&(o.addEventListener("click",()=>{this.addSection()}),o.setAttribute("data-listener-attached","true"));return}this.container.innerHTML=`
      <div class="gmkb-empty-state">
        <h3>No components yet</h3>
        <p>Click "Add Component" to get started</p>
        <button id="empty-state-add-btn" class="btn btn-primary">Add Component</button>
      </div>
    `;const n=this.container.querySelector("#empty-state-add-btn");n&&n.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("gmkb:open-component-library"))})}addSection(){const n={section_id:`section_${Date.now()}`,type:"full_width",components:[]};this.stateManager.dispatch({type:"ADD_SECTION",payload:n})}destroy(){this.unsubscribe&&this.unsubscribe()}}class _{constructor(t,n,e){var o,i,c;this.ajaxUrl=t||((o=window.gmkbData)==null?void 0:o.ajaxUrl),this.nonce=n||((i=window.gmkbData)==null?void 0:i.nonce),this.postId=e||((c=window.gmkbData)==null?void 0:c.postId)}async save(t){var e;const n=new FormData;n.append("action","gmkb_save_media_kit"),n.append("nonce",this.nonce),n.append("post_id",this.postId),n.append("state",JSON.stringify(t));try{const o=await fetch(this.ajaxUrl,{method:"POST",body:n});if(!o.ok)throw new Error(`Save failed: ${o.statusText}`);const i=await o.json();if(!i.success)throw new Error(((e=i.data)==null?void 0:e.message)||"Save failed");return i.data}catch(o){throw console.error("Save failed:",o),o}}async load(){var n;const t=new FormData;t.append("action","gmkb_load_media_kit"),t.append("nonce",this.nonce),t.append("post_id",this.postId);try{const e=await fetch(this.ajaxUrl,{method:"POST",body:t});if(!e.ok)throw new Error(`Load failed: ${e.statusText}`);const o=await e.json();if(!o.success)throw new Error(((n=o.data)==null?void 0:n.message)||"Load failed");return o.data}catch(e){return console.error("Load failed:",e),null}}async loadComponent(t){var e;const n=new FormData;n.append("action","gmkb_load_component"),n.append("nonce",this.nonce),n.append("component_id",t),n.append("post_id",this.postId);try{const i=await(await fetch(this.ajaxUrl,{method:"POST",body:n})).json();if(!i.success)throw new Error(((e=i.data)==null?void 0:e.message)||"Load failed");return i.data}catch(o){return console.error("Component load failed:",o),null}}}let a,$,f,T;async function I(){var s,t;r.info("üöÄ Initializing Media Kit Builder v3.0");try{$=new v,f=new _,await B();const n=((s=window.gmkbData)==null?void 0:s.savedState)||((t=window.gmkbData)==null?void 0:t.saved_state)||{};n.components||(n.components={}),(!n.sections||!Array.isArray(n.sections))&&(n.sections=[],Object.keys(n.components).length>0&&(n.sections=[{section_id:`section_${Date.now()}`,type:"full_width",components:Object.keys(n.components)}])),a=new g(n);const e=["gmkb-sections-container","saved-components-container","media-kit-preview","gmkb-preview-area"];let o="media-kit-preview";for(const i of e)if(document.getElementById(i)){o=i,r.info(`Using container: ${i}`);break}T=new S(a,o),L(),P(),j(),window.GMKB={stateManager:a,eventBus:$,apiService:f,renderer:T,version:"3.0.0",addComponent:(i,c={})=>{const d=`${i}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,l={id:d,type:i,data:c,props:c},m=a.getState();if(m.sections.length===0){const O=`section_${Date.now()}`;a.dispatch({type:"ADD_SECTION",payload:{section_id:O,type:"full_width",components:[]}}),l.sectionId=O}else l.sectionId=m.sections[0].section_id;return a.dispatch({type:"ADD_COMPONENT",payload:l}),d},removeComponent:i=>{a.dispatch({type:"REMOVE_COMPONENT",payload:i})},save:()=>y(),getState:()=>a.getState()},r.success("Media Kit Builder initialized successfully"),document.dispatchEvent(new CustomEvent("gmkb:ready",{detail:{version:"3.0.0"}}))}catch(n){r.error("Initialization failed:",n),z("Failed to initialize Media Kit Builder")}}function L(){const s=document.getElementById("save-btn");s&&s.addEventListener("click",async()=>{await y()});const t=document.getElementById("add-component-btn");t&&t.addEventListener("click",()=>{D()});const n=document.getElementById("add-section-btn");n&&n.addEventListener("click",()=>{R()});const e=document.getElementById("theme-select");e&&e.addEventListener("change",i=>{a.dispatch({type:"SET_THEME",payload:i.target.value})}),document.querySelectorAll("[data-device]").forEach(i=>{i.addEventListener("click",()=>{const c=i.dataset.device;K(c)})})}function P(){document.addEventListener("gmkb:component-action",s=>{const{action:t,componentId:n}=s.detail;switch(t){case"delete":confirm("Delete this component?")&&a.dispatch({type:"REMOVE_COMPONENT",payload:n});break;case"duplicate":x(n);break;case"edit":F(n);break;case"move-up":N(n,-1);break;case"move-down":N(n,1);break}}),document.addEventListener("gmkb:section-action",s=>{const{action:t,sectionId:n}=s.detail;switch(t){case"delete-section":confirm("Delete this section and all its components?")&&U(n);break;case"section-settings":q(n);break}}),document.addEventListener("gmkb:open-component-library",D)}function j(){let s;a.subscribe(()=>{clearTimeout(s),s=setTimeout(()=>{y(!0)},5e3)})}async function y(s=!1){const t=document.getElementById("save-btn");!s&&t&&(t.disabled=!0,t.textContent="Saving...");try{const n=a.getState();await f.save(n),s||p("Saved successfully","success"),r.success("State saved")}catch(n){r.error("Save failed:",n),s||p("Save failed","error")}finally{!s&&t&&(t.disabled=!1,t.textContent="Save")}}function D(){const s=document.getElementById("component-library-modal");s?(s.style.display="block",M()):H()}function H(){const s=document.createElement("div");s.id="component-library-modal",s.className="modal",s.innerHTML=`
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add Component</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body" id="component-library-list"></div>
    </div>
  `,document.body.appendChild(s),s.querySelector(".modal-close").addEventListener("click",()=>{s.style.display="none"}),s.addEventListener("click",t=>{t.target===s&&(s.style.display="none")}),M()}function M(){var n;const s=document.getElementById("component-library-list");if(!s)return;const t=((n=window.gmkbData)==null?void 0:n.components)||[{type:"hero",name:"Hero",description:"Hero section with title and image"},{type:"biography",name:"Biography",description:"Professional biography"},{type:"topics",name:"Topics",description:"Speaking topics list"},{type:"contact",name:"Contact",description:"Contact information"},{type:"cta",name:"Call to Action",description:"CTA button section"},{type:"testimonials",name:"Testimonials",description:"Client testimonials"}];s.innerHTML=t.map(e=>`
    <div class="component-card" data-component-type="${e.type}">
      <h3>${e.name}</h3>
      <p>${e.description}</p>
      <button class="btn btn-primary add-component-btn" data-type="${e.type}">
        Add ${e.name}
      </button>
    </div>
  `).join(""),s.querySelectorAll(".add-component-btn").forEach(e=>{e.addEventListener("click",()=>{const o=e.dataset.type;window.GMKB.addComponent(o);const i=document.getElementById("component-library-modal");i&&(i.style.display="none"),p(`Added ${o} component`,"success")})})}function R(s="full_width"){const n={section_id:`section_${Date.now()}`,type:s,components:[]};a.dispatch({type:"ADD_SECTION",payload:n}),p("Section added","success")}function U(s){const t=a.getState(),n=t.sections.filter(o=>o.section_id!==s),e=t.sections.find(o=>o.section_id===s);e&&e.components&&e.components.forEach(o=>{a.dispatch({type:"REMOVE_COMPONENT",payload:o})}),a.dispatch({type:"UPDATE_SECTIONS",payload:n})}function x(s){const n=a.getState().components[s];if(n){const e=`${n.type}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,o={...n,id:e,data:{...n.data}};a.dispatch({type:"ADD_COMPONENT",payload:o}),p("Component duplicated","success")}}function N(s,t){const n=a.getState(),e=n.components[s];if(!e||!e.sectionId)return;const o=n.sections.find(m=>m.section_id===e.sectionId);if(!o)return;const i=o.components.indexOf(s);if(i===-1)return;const c=i+t;if(c<0||c>=o.components.length)return;const d=[...o.components];[d[i],d[c]]=[d[c],d[i]];const l=n.sections.map(m=>m.section_id===o.section_id?{...m,components:d}:m);a.dispatch({type:"UPDATE_SECTIONS",payload:l})}function F(s){const t=a.getState().components[s];t&&(console.log("Edit component:",t),p("Component editor not yet implemented","info"))}function q(s){console.log("Edit section:",s),p("Section settings not yet implemented","info")}function K(s){const t=document.getElementById("media-kit-preview")||document.getElementById("preview-area");t&&(t.className=`preview-area device-${s}`)}function p(s,t="info",n=3e3){const e=document.createElement("div");e.className=`toast toast--${t}`,e.textContent=s,document.body.appendChild(e),setTimeout(()=>{e.classList.add("toast--visible")},10),setTimeout(()=>{e.classList.remove("toast--visible"),setTimeout(()=>e.remove(),300)},n)}function z(s){p(s,"error",5e3)}return document.readyState==="loading"?document.addEventListener("DOMContentLoaded",I):I(),u.APIService=_,u.EventBus=v,u.Renderer=S,u.StateManager=g,u.logger=r,Object.defineProperty(u,Symbol.toStringTag,{value:"Module"}),u}({});
