<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Fixes Test Suite</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            background: #f5f5f5;
        }
        
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .test-result.pass {
            background: #e8f5e9;
            border-left: 4px solid #4CAF50;
            color: #2e7d32;
        }
        
        .test-result.fail {
            background: #ffebee;
            border-left: 4px solid #f44336;
            color: #c62828;
        }
        
        .test-result.info {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            color: #1565c0;
        }
        
        .summary {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .summary.success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .summary.failure {
            background: #ffebee;
            color: #c62828;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .performance-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            margin: 5px 0;
        }
        
        .performance-bar {
            width: 60%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .performance-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <h1>üß™ Gemini Critical Fixes - Test Suite</h1>
    
    <div class="test-container">
        <h2>Test Controls</h2>
        <button onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
        <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
        <button onclick="runPerformanceTest()">‚ö° Run Performance Test Only</button>
    </div>
    
    <div class="test-container">
        <h2>Test Results</h2>
        <div id="test-results"></div>
        <div id="test-summary"></div>
    </div>

    <script type="module">
        // Import the utilities
        import { deepClone, generateUniqueId, deepEqual } from './src/utils/deepClone.js';
        
        // Make utilities available globally for testing
        window.deepClone = deepClone;
        window.generateUniqueId = generateUniqueId;
        window.deepEqual = deepEqual;
        
        console.log('‚úÖ Utilities loaded successfully');
        
        let testResults = [];
        let passedTests = 0;
        let totalTests = 0;
        
        window.runAllTests = function() {
            testResults = [];
            passedTests = 0;
            totalTests = 0;
            
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<div class="test-result info">üöÄ Running tests...</div>';
            
            // Run tests with small delay for UI feedback
            setTimeout(() => {
                runTests();
            }, 100);
        };
        
        window.clearResults = function() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('test-summary').innerHTML = '';
            testResults = [];
            passedTests = 0;
            totalTests = 0;
        };
        
        window.runPerformanceTest = function() {
            testResults = [];
            passedTests = 0;
            totalTests = 0;
            
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<div class="test-result info">‚ö° Running performance test...</div>';
            
            setTimeout(() => {
                runPerformanceTestOnly();
            }, 100);
        };
        
        function addResult(name, passed, message = '') {
            testResults.push({ name, passed, message });
            const resultsDiv = document.getElementById('test-results');
            const resultClass = passed ? 'pass' : 'fail';
            const icon = passed ? '‚úÖ' : '‚ùå';
            
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${resultClass}`;
            resultDiv.innerHTML = `${icon} <strong>${name}</strong>${message ? '<br>' + message : ''}`;
            resultsDiv.appendChild(resultDiv);
        }
        
        function addInfo(message) {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result info';
            resultDiv.innerHTML = `‚ÑπÔ∏è ${message}`;
            resultsDiv.appendChild(resultDiv);
        }
        
        function showSummary() {
            const summaryDiv = document.getElementById('test-summary');
            const successRate = (passedTests / totalTests * 100).toFixed(1);
            const isSuccess = passedTests === totalTests;
            
            summaryDiv.className = `summary ${isSuccess ? 'success' : 'failure'}`;
            summaryDiv.innerHTML = `
                üìä Test Results: ${passedTests}/${totalTests} passed (${successRate}%)
                ${isSuccess ? '<br>üéâ All tests passed!' : '<br>‚ö†Ô∏è Some tests failed'}
            `;
        }
        
        function runTests() {
            // Test 1: Deep Clone - No Shared References
            totalTests++;
            try {
                const original = {
                    id: '1',
                    nested: { value: 'test', array: [1, 2, 3] }
                };
                
                const cloned = deepClone(original);
                
                // Modify original
                original.nested.value = 'changed';
                original.nested.array.push(4);
                
                // Verify cloned is unchanged
                if (cloned.nested.value !== 'test') {
                    throw new Error('Deep clone failed - value was modified');
                }
                if (cloned.nested.array.length !== 3) {
                    throw new Error('Deep clone failed - array was modified');
                }
                
                passedTests++;
                addResult('Test 1: Deep Clone - No Shared References', true);
            } catch (error) {
                addResult('Test 1: Deep Clone - No Shared References', false, error.message);
            }
            
            // Test 2: Deep Clone - Handles Dates
            totalTests++;
            try {
                const original = {
                    date: new Date('2025-01-01'),
                    nested: { timestamp: new Date() }
                };
                
                const cloned = deepClone(original);
                
                if (!(cloned.date instanceof Date)) {
                    throw new Error('Date object not preserved');
                }
                if (cloned.date.getTime() !== original.date.getTime()) {
                    throw new Error('Date value not preserved');
                }
                
                passedTests++;
                addResult('Test 2: Deep Clone - Handles Dates', true);
            } catch (error) {
                addResult('Test 2: Deep Clone - Handles Dates', false, error.message);
            }
            
            // Test 3: Deep Clone - Handles Arrays
            totalTests++;
            try {
                const original = [1, 2, { nested: [3, 4] }];
                const cloned = deepClone(original);
                
                original[2].nested.push(5);
                
                if (cloned[2].nested.length !== 2) {
                    throw new Error('Array deep clone failed');
                }
                
                passedTests++;
                addResult('Test 3: Deep Clone - Handles Arrays', true);
            } catch (error) {
                addResult('Test 3: Deep Clone - Handles Arrays', false, error.message);
            }
            
            // Test 4: Generate Unique IDs
            totalTests++;
            try {
                const ids = new Set();
                
                // Generate 1000 IDs rapidly
                for (let i = 0; i < 1000; i++) {
                    const id = generateUniqueId('test');
                    if (ids.has(id)) {
                        throw new Error(`Duplicate ID found: ${id}`);
                    }
                    ids.add(id);
                }
                
                if (ids.size !== 1000) {
                    throw new Error('Not all IDs are unique');
                }
                
                passedTests++;
                addResult('Test 4: Generate 1000 Unique IDs', true, `All 1000 IDs are unique`);
            } catch (error) {
                addResult('Test 4: Generate 1000 Unique IDs', false, error.message);
            }
            
            // Test 5: Deep Equal - Identical Objects
            totalTests++;
            try {
                const obj1 = { a: 1, b: { c: 2, d: [3, 4] } };
                const obj2 = { a: 1, b: { c: 2, d: [3, 4] } };
                
                if (!deepEqual(obj1, obj2)) {
                    throw new Error('deepEqual failed for identical objects');
                }
                
                passedTests++;
                addResult('Test 5: Deep Equal - Identical Objects', true);
            } catch (error) {
                addResult('Test 5: Deep Equal - Identical Objects', false, error.message);
            }
            
            // Test 6: Deep Equal - Different Objects
            totalTests++;
            try {
                const obj1 = { a: 1, b: { c: 2 } };
                const obj2 = { a: 1, b: { c: 3 } };
                
                if (deepEqual(obj1, obj2)) {
                    throw new Error('deepEqual failed to detect difference');
                }
                
                passedTests++;
                addResult('Test 6: Deep Equal - Different Objects', true);
            } catch (error) {
                addResult('Test 6: Deep Equal - Different Objects', false, error.message);
            }
            
            // Test 7: Deep Equal - Performance
            totalTests++;
            try {
                const largeObj = {};
                for (let i = 0; i < 100; i++) {
                    largeObj[`key${i}`] = { nested: { value: i, array: [i, i+1, i+2] } };
                }
                
                const obj1 = deepClone(largeObj);
                const obj2 = deepClone(largeObj);
                
                // Test JSON method
                const jsonStart = performance.now();
                const jsonResult = JSON.stringify(obj1) === JSON.stringify(obj2);
                const jsonTime = performance.now() - jsonStart;
                
                // Test deepEqual method
                const deepStart = performance.now();
                const deepResult = deepEqual(obj1, obj2);
                const deepTime = performance.now() - deepStart;
                
                const speedup = (jsonTime / deepTime).toFixed(1);
                
                passedTests++;
                addResult('Test 7: Deep Equal - Performance', true, 
                    `JSON: ${jsonTime.toFixed(3)}ms, deepEqual: ${deepTime.toFixed(3)}ms (${speedup}x faster)`);
                
                // Add visual performance comparison
                addPerformanceVisualization(jsonTime, deepTime);
                
            } catch (error) {
                addResult('Test 7: Deep Equal - Performance', false, error.message);
            }
            
            // Test 8: Component Duplication Simulation
            totalTests++;
            try {
                const originalComponent = {
                    id: 'comp1',
                    type: 'hero',
                    data: {
                        title: 'Original',
                        content: { text: 'Test', nested: { deep: 'value' } }
                    },
                    props: { fontSize: 16 },
                    settings: { visible: true }
                };
                
                // Simulate duplication
                const cloned = deepClone(originalComponent);
                cloned.id = generateUniqueId('comp');
                cloned.createdAt = Date.now();
                
                // Modify original
                originalComponent.data.title = 'Modified';
                originalComponent.data.content.nested.deep = 'changed';
                originalComponent.props.fontSize = 24;
                
                // Verify clone is unchanged
                if (cloned.data.title !== 'Original') {
                    throw new Error('Title was affected');
                }
                if (cloned.data.content.nested.deep !== 'value') {
                    throw new Error('Nested data was affected');
                }
                if (cloned.props.fontSize !== 16) {
                    throw new Error('Props were affected');
                }
                
                passedTests++;
                addResult('Test 8: Component Duplication (Real World)', true, 
                    'Component duplication prevents all data bleeding');
            } catch (error) {
                addResult('Test 8: Component Duplication (Real World)', false, error.message);
            }
            
            // Show summary
            showSummary();
        }
        
        function runPerformanceTestOnly() {
            totalTests = 1;
            
            try {
                addInfo('Creating large test object (100 properties with nested data)...');
                
                const largeObj = {};
                for (let i = 0; i < 100; i++) {
                    largeObj[`key${i}`] = { 
                        nested: { 
                            value: i, 
                            array: [i, i+1, i+2],
                            moreNesting: {
                                deep: 'value' + i
                            }
                        } 
                    };
                }
                
                addInfo('Creating deep clones for comparison...');
                const obj1 = deepClone(largeObj);
                const obj2 = deepClone(largeObj);
                
                // Test JSON method multiple times for accuracy
                addInfo('Testing JSON.stringify method (10 iterations)...');
                let jsonTotalTime = 0;
                for (let i = 0; i < 10; i++) {
                    const jsonStart = performance.now();
                    const jsonResult = JSON.stringify(obj1) === JSON.stringify(obj2);
                    jsonTotalTime += performance.now() - jsonStart;
                }
                const jsonAvgTime = jsonTotalTime / 10;
                
                // Test deepEqual method multiple times for accuracy
                addInfo('Testing deepEqual method (10 iterations)...');
                let deepTotalTime = 0;
                for (let i = 0; i < 10; i++) {
                    const deepStart = performance.now();
                    const deepResult = deepEqual(obj1, obj2);
                    deepTotalTime += performance.now() - deepStart;
                }
                const deepAvgTime = deepTotalTime / 10;
                
                const speedup = (jsonAvgTime / deepAvgTime).toFixed(1);
                
                passedTests++;
                addResult('Performance Test: deepEqual vs JSON.stringify', true, 
                    `Average over 10 runs:<br>` +
                    `JSON Method: ${jsonAvgTime.toFixed(3)}ms<br>` +
                    `deepEqual Method: ${deepAvgTime.toFixed(3)}ms<br>` +
                    `<strong>Speedup: ${speedup}x faster! üöÄ</strong>`);
                
                // Add detailed performance visualization
                addPerformanceVisualization(jsonAvgTime, deepAvgTime);
                
                // Test with different object
                addInfo('Testing with modified object (should detect difference quickly)...');
                const obj3 = deepClone(obj1);
                obj3.key50.nested.value = 999; // Change one value
                
                const diffStart = performance.now();
                const isDifferent = !deepEqual(obj1, obj3);
                const diffTime = performance.now() - diffStart;
                
                if (isDifferent) {
                    addResult('Quick Difference Detection', true,
                        `Detected difference in ${diffTime.toFixed(3)}ms (early exit optimization)`);
                }
                
            } catch (error) {
                addResult('Performance Test', false, error.message);
            }
            
            showSummary();
        }
        
        function addPerformanceVisualization(jsonTime, deepTime) {
            const resultsDiv = document.getElementById('test-results');
            const maxTime = Math.max(jsonTime, deepTime);
            
            const vizDiv = document.createElement('div');
            vizDiv.innerHTML = `
                <div style="margin: 15px 0; padding: 15px; background: #f9f9f9; border-radius: 4px;">
                    <h4 style="margin-top: 0;">Performance Comparison</h4>
                    <div class="performance-result">
                        <span style="width: 150px; font-weight: bold;">JSON Method:</span>
                        <div class="performance-bar">
                            <div class="performance-bar-fill" style="width: ${(jsonTime / maxTime * 100)}%; background: linear-gradient(90deg, #f44336, #ff5722);"></div>
                        </div>
                        <span style="width: 100px; text-align: right;">${jsonTime.toFixed(3)}ms</span>
                    </div>
                    <div class="performance-result">
                        <span style="width: 150px; font-weight: bold;">deepEqual:</span>
                        <div class="performance-bar">
                            <div class="performance-bar-fill" style="width: ${(deepTime / maxTime * 100)}%;"></div>
                        </div>
                        <span style="width: 100px; text-align: right;">${deepTime.toFixed(3)}ms</span>
                    </div>
                    <div style="text-align: center; margin-top: 10px; font-size: 18px; color: #4CAF50; font-weight: bold;">
                        ‚ö° ${(jsonTime / deepTime).toFixed(1)}x faster!
                    </div>
                </div>
            `;
            resultsDiv.appendChild(vizDiv);
        }
        
        // Auto-run tests on page load
        addInfo('Page loaded. Click "Run All Tests" to begin testing.');
        
    </script>
</body>
</html>
